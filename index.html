<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VANS RV6 Performance Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .info-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            border: none;
            vertical-align: middle;
        }
        .tooltip {
            display: none;
            position: fixed;
            background-color: #1f2937;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            max-width: 280px;
            z-index: 1000;
            font-size: 10px;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tooltip.visible {
            display: block;
        }
        .info-button:focus + .tooltip {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-w            if (resetDataBtn) {
                resetDataBtn.addEventListener('click', async function() {
                    localStorage.removeItem('propPitchBias');
                    localStorage.removeItem('climbPerformanceData');
                    localStorage.removeItem('takeoffPerformanceData');
                    localStorage.removeItem('landingPerformanceData');
                    propPitchSlider.value = 100;
                    window.propPitchBias = 1.0;
                    propPitchValue.textContent = '100%';
                    await initializePerformanceCharts();
                    showMessage('Performance data reset to default values.', 'success');
                });
            }

            // Safety Factor slider handler
            if (safetyFactorSlider) {
                safetyFactorSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    safetyFactorValue.textContent = value + '%';
                    
                    // Update both takeoff and landing calculations to show new safety margins
                    updateTakeoffPerformance();
                    updateLandingPerformance();
                });
            }

            // Initial rendering of the chart with default valuesl shadow-xl overflow-hidden p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">VANS RV6 Performance Tool</h1>
            <p class="text-md text-gray-600 mt-2">Calculate takeoff, climb and landing performance</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab1-btn" class="flex-1 py-3 px-4 text-center font-medium text-gray-700 hover:text-blue-600 focus:outline-none transition-all duration-200 rounded-t-lg border-b-2 border-transparent hover:border-blue-600 active:border-blue-600">
                Performance Chart
            </button>
            <button id="tab2-btn" class="flex-1 py-3 px-4 text-center font-medium text-gray-700 hover:text-blue-600 focus:outline-none transition-all duration-200 rounded-t-lg border-b-2 border-transparent hover:border-blue-600">
                Performance Calculator
            </button>
        </div>

        <!-- Tab 1: Performance Chart -->
        <div id="tab1-content" class="tab-content active">
            <!-- Static Weight Display and Prop Pitch Slider -->
            <div class="mb-4 space-y-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-700">Standard Weight: 1700 lbs</span>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg">
                    <label for="prop-pitch-bias" class="block text-sm font-medium text-gray-700 mb-2">PROP Pitch Setting</label>
                    <div class="flex items-center space-x-4 mb-3">
                        <span class="text-sm text-gray-600 whitespace-nowrap">Takeoff/Climb</span>
                        <input type="range" id="prop-pitch-bias" 
                            min="80" max="120" value="100" step="1"
                            class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        >
                        <span class="text-sm text-gray-600 whitespace-nowrap">Cruise</span>
                        <span id="prop-pitch-value" class="text-sm font-semibold bg-blue-100 px-2 py-1 rounded">100%</span>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button id="save-data-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                            ðŸ’¾ Save Changes
                        </button>
                        <button id="reset-data-btn" class="px-4 py-2 bg-gray-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            â†º Reset to Default
                        </button>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto mb-8">
                <h2 class="text-lg font-bold text-gray-800 mb-2">Climb Performance Chart</h2>
                <table class="min-w-full text-center" id="performance-chart">
                    <thead class="bg-[#593D2B] text-white">
                        <tr>
                            <th class="py-3 px-2 font-semibold text-sm rounded-tl-lg">Altitude (ft)</th>
                            <th class="py-3 px-2 font-semibold text-sm">Indicated Airspeed (KIAS)</th>
                            <th class="py-3 px-2 font-semibold text-sm">Climb Rate (ft/min)</th>
                            <th class="py-3 px-2 font-semibold text-sm">Fuel Flow (gph)</th>
                            <th class="py-3 px-2 font-semibold text-sm">True Airspeed (KTAS)</th>
                            <th class="py-3 px-2 font-semibold text-sm rounded-tr-lg">Climb Gradient (ft/nm)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white" id="chart-body">
                        <!-- Data rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Takeoff Distance Chart -->
            <div class="overflow-x-auto mb-8">
                <h2 class="text-lg font-bold text-gray-800 mb-2">Takeoff Distance Chart</h2>
                <table class="min-w-full text-center" id="takeoff-distance-chart">
                    <thead class="bg-blue-800 text-white">
                        <tr>
                            <th class="py-3 px-2 font-semibold text-sm rounded-tl-lg">Altitude (ft)</th>
                            <th class="py-3 px-2 font-semibold text-sm">Ground Roll (ft)</th>
                            <th class="py-3 px-2 font-semibold text-sm rounded-tr-lg">Distance over 50ft (ft)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white" id="takeoff-distance-body">
                        <!-- Data rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Landing Distance Chart -->
            <div class="overflow-x-auto mb-8">
                <h2 class="text-lg font-bold text-gray-800 mb-2">Landing Distance Chart</h2>
                <table class="min-w-full text-center" id="landing-distance-chart">
                    <thead class="bg-green-800 text-white">
                        <tr>
                            <th class="py-3 px-2 font-semibold text-sm rounded-tl-lg">Altitude (ft)</th>
                            <th class="py-3 px-2 font-semibold text-sm">Ground Roll (ft)</th>
                            <th class="py-3 px-2 font-semibold text-sm rounded-tr-lg">Distance over 50ft (ft)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white" id="landing-distance-body">
                        <!-- Data rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Cruise Performance Chart -->
            <div class="overflow-x-auto mb-8">
                <h2 class="text-lg font-bold text-gray-800 mb-2">Cruise Table</h2>
                <table class="min-w-full text-center" id="cruise-chart">
                    <thead class="bg-purple-800 text-white">
                        <tr>
                            <th class="py-3 px-2 font-semibold text-sm rounded-tl-lg">Altitude (ft)</th>
                            <th class="py-3 px-2 font-semibold text-sm">Economy KTAS</th>
                            <th class="py-3 px-2 font-semibold text-sm">Economy GPH</th>
                            <th class="py-3 px-2 font-semibold text-sm">High Power KTAS</th>
                            <th class="py-3 px-2 font-semibold text-sm rounded-tr-lg">High Power GPH</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white" id="cruise-body">
                        <!-- Data rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

        </div>

        <!-- Tab 2: Performance Calculator -->
        <div id="tab2-content" class="tab-content">
            <!-- Safety Factor Slider -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <label for="safety-factor" class="block text-sm font-medium text-gray-700 mb-2">Safety Factor</label>
                <div class="flex items-center space-x-4 mb-3">
                    <span class="text-sm text-gray-600 whitespace-nowrap">0%</span>
                    <input type="range" id="safety-factor" 
                        min="0" max="100" value="25" step="5"
                        class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                        title="Add a safety margin to takeoff and landing distances. This helps account for non-ideal conditions and pilot technique.">
                    <span class="text-sm text-gray-600 whitespace-nowrap">100%</span>
                    <span id="safety-factor-value" class="text-sm font-semibold bg-green-100 px-2 py-1 rounded">25%</span>
                </div>
                <div class="flex justify-end space-x-2 mt-2">
                    <button id="save-calculator-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        ðŸ’¾ Save Settings
                    </button>
                    <button id="reset-calculator-btn" class="px-4 py-2 bg-gray-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        â†º Reset to Default
                    </button>
                </div>
            </div>
            <!-- TAKEOFF Section -->
            <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="text-lg font-bold text-blue-800 mb-4">Takeoff</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="takeoff-weight-input" class="block text-sm font-medium text-gray-700 mb-1">Takeoff Weight (lbs)</label>
                        <input type="number" id="takeoff-weight-input" value="1700" min="1400" max="1700" 
                            class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Weight affects performance by approximately -10% per 10% of max weight (1700 lbs). A lighter aircraft will have better performance.">
                    </div>
                    <div>
                        <label for="takeoff-oat" class="block text-sm font-medium text-gray-700 mb-1">Takeoff OAT (Â°C)</label>
                        <input type="number" id="takeoff-oat" value="15" 
                            class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Outside Air Temperature affects density altitude. Performance changes by approximately 2% per 10Â°C from standard (15Â°C). Higher temperatures reduce performance.">
                    </div>
                    <div>
                        <label for="takeoff-surface" class="block text-sm font-medium text-gray-700 mb-1">Runway Surface Type</label>
                        <select id="takeoff-surface" class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Surface factors: Paved = 1.0 (base), Grass = 1.15 (+15% distance), Gravel = 1.10 (+10% distance)">
                            <option value="paved">Paved</option>
                            <option value="grass">Grass</option>
                            <option value="gravel">Gravel</option>
                        </select>
                    </div>
                    <div>
                        <label for="takeoff-elevation" class="block text-sm font-medium text-gray-700 mb-1">Takeoff Elevation (ft)</label>
                        <div class="relative">
                            <input type="number" id="takeoff-elevation" value="0" min="0" 
                                class="w-full p-3 pr-24 border border-gray-300 rounded-lg"
                                title="Field elevation affects density altitude and true airspeed. Higher elevations reduce performance based on the standard lapse rate.">
                            <span id="takeoff-da-display" class="absolute right-8 top-2 text-[10px] leading-tight text-gray-500 bg-white/95 px-1 py-0.5 rounded-sm whitespace-nowrap"></span>
                        </div>
                    </div>
                    <div>
                        <label for="takeoff-wind" class="block text-sm font-medium text-gray-700 mb-1">Winds at Takeoff (knots, +/-)</label>
                        <input type="text" inputmode="numeric" pattern="[+-]?\d*" id="takeoff-wind" value="0" 
                            class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Wind effect: Headwind (+) decreases distance by 10% per 10 knots. Tailwind (-) increases distance by 10% per 2 knots."
                            placeholder="+/- knots">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white rounded-lg border border-gray-200"
                        title="Ground Roll = Base distance Ã— Surface factor Ã— Wind factor Ã— OAT factor Ã— Weight factor. Base distance is interpolated from the performance chart based on elevation.">
                        <span class="block text-sm font-medium text-gray-600">Ground Roll:</span>
                        <span id="takeoff-performance-result" class="text-lg font-bold text-blue-800"></span>
                        <span id="takeoff-performance-safe" class="block text-sm text-green-600 mt-1"></span>
                    </div>
                    <div class="p-4 bg-white rounded-lg border border-gray-200"
                        title="Total Distance = Ground Roll Ã— 1.7. The distance to clear a 50ft obstacle is typically 70% more than the ground roll distance.">
                        <span class="block text-sm font-medium text-gray-600">Distance over 50ft:</span>
                        <span id="takeoff-over50ft-result" class="text-lg font-bold text-blue-800"></span>
                        <span id="takeoff-over50ft-safe" class="block text-sm text-green-600 mt-1"></span>
                    </div>
                </div>
            </div>

            <!-- CLIMB Section -->
            <div class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200">
                <h2 class="text-lg font-bold text-green-800 mb-4">Climb</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="cruise-altitude" class="block text-sm font-medium text-gray-700 mb-1">Cruise Altitude (ft)</label>
                        <div class="relative">
                            <input type="number" id="cruise-altitude" value="5000" min="0" 
                                class="w-full p-3 pr-24 border border-gray-300 rounded-lg"
                                title="Target altitude for the climb. Climb performance decreases with altitude according to the performance chart. Maximum practical ceiling around 18,000 ft.">
                            <span id="cruise-da-display" class="absolute right-8 top-2 text-[10px] leading-tight text-gray-500 bg-white/95 px-1 py-0.5 rounded-sm whitespace-nowrap"></span>
                        </div>
                    </div>
                    <div>
                        <label for="winds-aloft" class="block text-sm font-medium text-gray-700 mb-1">Winds Aloft (knots, +/-)</label>
                        <input type="text" inputmode="numeric" pattern="[+-]?\d*" id="winds-aloft" value="0" 
                            class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Winds at cruise altitude. Wind is interpolated between takeoff and cruise altitude. Positive = headwind, Negative = tailwind. Affects ground speed and distance calculations."
                            placeholder="+/- knots">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-white rounded-lg border border-gray-200"
                        title="Time = Î£(Segment Height Ã· Average Rate of Climb). Calculated in 100ft segments using interpolated climb rates from the performance chart.">
                        <span class="block text-sm font-medium text-gray-600">Time to Cruise Altitude:</span>
                        <span id="time-to-cruise-result" class="text-lg font-bold text-green-800"></span>
                    </div>
                    <div class="p-4 bg-white rounded-lg border border-gray-200"
                        title="Distance = Î£(Ground Speed Ã— Time). Ground Speed = True Airspeed - Interpolated Wind. True airspeed increases with altitude by ~2% per 1000ft.">
                        <span class="block text-sm font-medium text-gray-600">Distance to Cruise Altitude:</span>
                        <span id="distance-to-cruise-result" class="text-lg font-bold text-green-800"></span>
                    </div>
                    <div class="p-4 bg-white rounded-lg border border-gray-200"
                        title="Average Gradient = Total Altitude Gain Ã· Total Distance. Higher gradients indicate steeper climbs. Affected by winds - headwinds increase gradient, tailwinds decrease it.">
                        <span class="block text-sm font-medium text-gray-600">Average Climb Gradient (ft/nm):</span>
                        <span id="avg-climb-gradient-result" class="text-lg font-bold text-green-800"></span>
                    </div>
                    <div class="p-4 bg-white rounded-lg border border-gray-200"
                        title="Total fuel burn during climb based on interpolated fuel flow rates. Not affected by prop pitch setting.">
                        <span class="block text-sm font-medium text-gray-600">Fuel Burn in Climb:</span>
                        <span id="fuel-burn-result" class="text-lg font-bold text-green-800"></span>
                    </div>
                </div>
            </div>

            <!-- LANDING Section -->
            <div class="mb-8 p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                <h2 class="text-lg font-bold text-yellow-800 mb-4">Landing</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="landing-weight" class="block text-sm font-medium text-gray-700 mb-1">Landing Weight (lbs)</label>
                        <input type="number" id="landing-weight" value="1700" min="1400" max="1700" 
                            class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Weight affects landing distance by approximately -10% per 10% weight change (from 1700 lbs). A lighter aircraft will require less landing distance.">
                    </div>
                    <div>
                        <label for="landing-oat" class="block text-sm font-medium text-gray-700 mb-1">Landing OAT (Â°C)</label>
                        <input type="number" id="landing-oat" value="15" 
                            class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Outside Air Temperature affects density altitude. Landing distance changes by approximately 2% per 10Â°C from standard (15Â°C). Higher temperatures increase landing distance.">
                    </div>
                    <div>
                        <label for="landing-surface" class="block text-sm font-medium text-gray-700 mb-1">Runway Surface Type</label>
                        <select id="landing-surface" 
                            class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Surface factors: Paved = 1.0 (base), Grass = 1.15 (+15% distance), Gravel = 1.10 (+10% distance). Same factors as takeoff.">
                            <option value="paved">Paved</option>
                            <option value="grass">Grass</option>
                            <option value="gravel">Gravel</option>
                        </select>
                    </div>
                    <div>
                        <label for="landing-elevation" class="block text-sm font-medium text-gray-700 mb-1">Landing Elevation (ft)</label>
                        <div class="relative">
                            <input type="number" id="landing-elevation" value="0" min="0" 
                                class="w-full p-3 pr-24 border border-gray-300 rounded-lg"
                                title="Field elevation affects density altitude and true airspeed. Higher elevations increase landing distance based on the standard lapse rate.">
                            <span id="landing-da-display" class="absolute right-8 top-2 text-[10px] leading-tight text-gray-500 bg-white/95 px-1 py-0.5 rounded-sm whitespace-nowrap"></span>
                        </div>
                    </div>
                    <div>
                        <label for="landing-wind" class="block text-sm font-medium text-gray-700 mb-1">Winds at Landing (knots, +/-)</label>
                        <input type="text" inputmode="numeric" pattern="[+-]?\d*" id="landing-wind" value="0" 
                            class="w-full p-3 border border-gray-300 rounded-lg"
                            title="Wind effect: Headwind (+) decreases distance by 10% per 10 knots. Tailwind (-) increases distance by 10% per 2 knots. Same factors as takeoff."
                            placeholder="+/- knots">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white rounded-lg border border-gray-200"
                        title="Ground Roll = Base distance Ã— Surface factor Ã— Wind factor Ã— OAT factor Ã— Weight factor. Base distance is interpolated from the performance chart based on elevation.">
                        <span class="block text-sm font-medium text-gray-600">Ground Roll:</span>
                        <span id="landing-performance-result" class="text-lg font-bold text-yellow-800"></span>
                        <span id="landing-performance-safe" class="block text-sm text-green-600 mt-1"></span>
                    </div>
                    <div class="p-4 bg-white rounded-lg border border-gray-200"
                        title="Total Distance = Ground Roll Ã— 1.8. The distance from 50ft to touchdown plus ground roll is typically 80% more than the ground roll distance alone.">
                        <span class="block text-sm font-medium text-gray-600">Distance over 50ft:</span>
                        <span id="landing-over50ft-result" class="text-lg font-bold text-yellow-800"></span>
                        <span id="landing-over50ft-safe" class="block text-sm text-green-600 mt-1"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error/Message Box -->
        <div id="message-box" class="mt-8 hidden p-4 bg-red-100 border border-red-300 rounded-lg text-red-700">
            <p id="message-text"></p>
        </div>

        <p class="text-sm text-gray-500 mt-8 italic text-center">
            Note: These calculations are estimations. Always refer to your aircraft's POH for official performance figures.
        </p>
    </div>

    <script>
    window.liveChartData = [];
    window.liveTakeoffData = [];
    window.liveLandingData = [];
    window.liveCruiseData = [];
    window.propPitchBias = 1.0;
    // Embedded performance data (from CSVs)
    const initialCruiseData = [
        { altitude: 0, econ_ktas: 130, econ_ff: 6.8, fast_ktas: 155, fast_ff: 12.5 },
        { altitude: 1000, econ_ktas: 132, econ_ff: 6.7, fast_ktas: 157, fast_ff: 12.5 },
        { altitude: 2000, econ_ktas: 134, econ_ff: 6.7, fast_ktas: 158, fast_ff: 12.5 },
        { altitude: 3000, econ_ktas: 136, econ_ff: 6.6, fast_ktas: 160, fast_ff: 12.5 },
        { altitude: 4000, econ_ktas: 140, econ_ff: 6.8, fast_ktas: 160, fast_ff: 11.0 },
        { altitude: 5000, econ_ktas: 143, econ_ff: 7.0, fast_ktas: 160, fast_ff: 10.7 },
        { altitude: 6000, econ_ktas: 145, econ_ff: 6.8, fast_ktas: 161, fast_ff: 10.5 },
        { altitude: 7000, econ_ktas: 146, econ_ff: 6.8, fast_ktas: 161, fast_ff: 10.5 },
        { altitude: 8000, econ_ktas: 148, econ_ff: 6.8, fast_ktas: 162, fast_ff: 10.3 },
        { altitude: 9000, econ_ktas: 150, econ_ff: 6.8, fast_ktas: 162, fast_ff: 10.0 },
        { altitude: 10000, econ_ktas: 151, econ_ff: 6.7, fast_ktas: 160, fast_ff: 9.5 },
        { altitude: 11000, econ_ktas: 149, econ_ff: 6.6, fast_ktas: 158, fast_ff: 9.0 },
        { altitude: 12000, econ_ktas: 146, econ_ff: 6.4, fast_ktas: 155, fast_ff: 8.5 },
        { altitude: 13000, econ_ktas: 144, econ_ff: 6.1, fast_ktas: 153, fast_ff: 7.8 },
        { altitude: 14000, econ_ktas: 142, econ_ff: 5.9, fast_ktas: 151, fast_ff: 7.3 },
        { altitude: 15000, econ_ktas: 140, econ_ff: 5.7, fast_ktas: 148, fast_ff: 6.9 },
        { altitude: 16000, econ_ktas: 137, econ_ff: 5.5, fast_ktas: 145, fast_ff: 6.5 },
        { altitude: 17000, econ_ktas: 134, econ_ff: 5.3, fast_ktas: 142, fast_ff: 6.1 },
        { altitude: 18000, econ_ktas: 132, econ_ff: 5.0, fast_ktas: 138, fast_ff: 5.7 }
    ];
    const initialPerformanceData = [
        { altitude: 0, kias: 105, rate: 1200, fuel_flow: 15.0 },
        { altitude: 1000, kias: 105, rate: 1140, fuel_flow: 14.5 },
        { altitude: 2000, kias: 105, rate: 1080, fuel_flow: 14.0 },
        { altitude: 3000, kias: 110, rate: 1000, fuel_flow: 13.5 },
        { altitude: 4000, kias: 110, rate: 920, fuel_flow: 12.5 },
        { altitude: 5000, kias: 110, rate: 830, fuel_flow: 11.7 },
        { altitude: 6000, kias: 110, rate: 730, fuel_flow: 11.2 },
        { altitude: 7000, kias: 110, rate: 610, fuel_flow: 10.8 },
        { altitude: 8000, kias: 110, rate: 500, fuel_flow: 10.4 },
        { altitude: 9000, kias: 105, rate: 470, fuel_flow: 10.0 },
        { altitude: 10000, kias: 105, rate: 430, fuel_flow: 9.5 },
        { altitude: 11000, kias: 105, rate: 370, fuel_flow: 9.0 },
        { altitude: 12000, kias: 100, rate: 310, fuel_flow: 8.5 },
        { altitude: 13000, kias: 100, rate: 250, fuel_flow: 8.1 },
        { altitude: 14000, kias: 100, rate: 220, fuel_flow: 7.6 },
        { altitude: 15000, kias: 100, rate: 170, fuel_flow: 7.1 },
        { altitude: 16000, kias: 95, rate: 120, fuel_flow: 6.5 },
        { altitude: 17000, kias: 95, rate: 60, fuel_flow: 6.2 },
        { altitude: 18000, kias: 95, rate: 20, fuel_flow: 5.7 }
    ];
    function calcDistanceOver50ft(groundRoll, type) {
        return type === 'takeoff' ? Math.round(groundRoll * 1.7) : Math.round(groundRoll * 1.8);
    }
    const takeoffPerformance = [
        { altitude: 0, groundRoll: 575 },
        { altitude: 1000, groundRoll: 605 },
        { altitude: 2000, groundRoll: 640 },
        { altitude: 3000, groundRoll: 680 },
        { altitude: 4000, groundRoll: 725 },
        { altitude: 5000, groundRoll: 780 },
        { altitude: 6000, groundRoll: 850 },
        { altitude: 7000, groundRoll: 940 },
        { altitude: 8000, groundRoll: 1050 },
        { altitude: 9000, groundRoll: 1180 },
        { altitude: 10000, groundRoll: 1335 },
        { altitude: 11000, groundRoll: 1520 },
        { altitude: 12000, groundRoll: 1740 },
        { altitude: 13000, groundRoll: 2000 },
        { altitude: 14000, groundRoll: 2310 }
    ].map(row => ({ ...row, over50ft: calcDistanceOver50ft(row.groundRoll, 'takeoff') }));
    const landingPerformance = [
        { altitude: 0, groundRoll: 525 },
        { altitude: 1000, groundRoll: 550 },
        { altitude: 2000, groundRoll: 580 },
        { altitude: 3000, groundRoll: 615 },
        { altitude: 4000, groundRoll: 660 },
        { altitude: 5000, groundRoll: 715 },
        { altitude: 6000, groundRoll: 785 },
        { altitude: 7000, groundRoll: 875 },
        { altitude: 8000, groundRoll: 990 },
        { altitude: 9000, groundRoll: 1135 },
        { altitude: 10000, groundRoll: 1315 },
        { altitude: 11000, groundRoll: 1540 },
        { altitude: 12000, groundRoll: 1775 },
        { altitude: 13000, groundRoll: 2000 },
        { altitude: 14000, groundRoll: 2300 }
    ].map(row => ({ ...row, over50ft: calcDistanceOver50ft(row.groundRoll, 'landing') }));
    document.addEventListener('DOMContentLoaded', function () {
            // Declare chart containers and all other elements after DOM is loaded
            window.chartBody = document.getElementById('chart-body');
            window.takeoffDistanceBody = document.getElementById('takeoff-distance-body');
            window.landingDistanceBody = document.getElementById('landing-distance-body');

            // Tab and button elements
            const tab1Btn = document.getElementById('tab1-btn');
            const tab2Btn = document.getElementById('tab2-btn');
            const tab1Content = document.getElementById('tab1-content');
            const tab2Content = document.getElementById('tab2-content');
            const saveDataBtn = document.getElementById('save-data-btn');
            const resetDataBtn = document.getElementById('reset-data-btn');
            // Performance Calculator tab elements (new layout)
            // TAKEOFF
            const takeoffWeightInput2 = document.getElementById('takeoff-weight-input');
            const takeoffOATInput = document.getElementById('takeoff-oat');
            const takeoffSurfaceInput = document.getElementById('takeoff-surface');
            const takeoffElevationInput = document.getElementById('takeoff-elevation');
            const takeoffWindInput = document.getElementById('takeoff-wind');
            const takeoffPerfResult = document.getElementById('takeoff-performance-result');
            const takeoffOver50ftResult = document.getElementById('takeoff-over50ft-result');
            // CRUISE
            const cruiseAltitudeInput = document.getElementById('cruise-altitude');
            const windsAloftInput = document.getElementById('winds-aloft');
            const timeToCruiseResult = document.getElementById('time-to-cruise-result');
            const distanceToCruiseResult = document.getElementById('distance-to-cruise-result');
            const avgClimbGradientResult = document.getElementById('avg-climb-gradient-result');
            // LANDING
            const landingWeightInput = document.getElementById('landing-weight');
            const landingOATInput = document.getElementById('landing-oat');
            const landingSurfaceInput = document.getElementById('landing-surface');
            const landingElevationInput = document.getElementById('landing-elevation');
            const landingWindInput = document.getElementById('landing-wind');
            const landingPerfResult = document.getElementById('landing-performance-result');
            const landingOver50ftResult = document.getElementById('landing-over50ft-result');
            // Error/message
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            // --- Standard aviation adjustment formulas ---
            function surfaceFactor(type) {
                if (type === 'grass') return 1.15;
                if (type === 'gravel') return 1.10;
                return 1.0;
            }
            function windFactor(wind) {
                // Positive wind is headwind, negative is tailwind
                if (wind >= 0) {
                    // Headwind: 10% decrease per 10 knots
                    return 1 - (wind / 100);
                } else {
                    // Tailwind: 10% increase per 2 knots (wind is negative)
                    return 1 - ((wind / 2) / 10); // negative wind makes this an increase
                }
            }
            function getStandardTemp(altitude) {
                // Standard temperature at sea level is 15Â°C
                // Temperature decreases by 2Â°C per 1000 feet
                const lapseRate = -2; // degrees C per 1000 feet
                return 15 + (altitude / 1000) * lapseRate;
            }

            function getISADeviation(oat, altitude) {
                // Calculate deviation from standard temperature at altitude
                return oat - getStandardTemp(altitude);
            }

            function getPressureAltitude(fieldElevation) {
                // For simplicity, assuming standard pressure (29.92 inHg)
                // In a real implementation, this would use actual altimeter setting
                return fieldElevation;
            }

            function getDensityAltitude(elevation, oat) {
                const pressureAltitude = getPressureAltitude(elevation);
                const isaTemp = getStandardTemp(elevation);
                // DA = PA + [120 Ã— (OAT - ISA)]
                const densityAlt = Math.round(pressureAltitude + (120 * (oat - isaTemp)));
                console.log(`DA Calculation - Elev: ${elevation}ft, OAT: ${oat}Â°C, ISA: ${isaTemp}Â°C, PA: ${pressureAltitude}ft, DA: ${densityAlt}ft`);
                return densityAlt;
            }

            function getCruiseDensityAltitude(cruiseAlt, takeoffElev, takeoffOAT) {
                // Get ISA deviation at takeoff
                const takeoffISADev = getISADeviation(takeoffOAT, takeoffElev);
                // Apply same ISA deviation at cruise altitude
                const cruiseOAT = getStandardTemp(cruiseAlt) + takeoffISADev;
                return getDensityAltitude(cruiseAlt, cruiseOAT);
            }
            function weightFactor(weight) {
                // Lighter = better, approx 15% reduction per 10% below 1700lbs
                return 1 - ((1700 - weight) / 1700);
            }

            // Safety factor handling
            const safetyFactorSlider = document.getElementById('safety-factor');
            const safetyFactorValue = document.getElementById('safety-factor-value');
            const takeoffPerfSafe = document.getElementById('takeoff-performance-safe');
            const takeoffOver50ftSafe = document.getElementById('takeoff-over50ft-safe');
            const landingPerfSafe = document.getElementById('landing-performance-safe');
            const landingOver50ftSafe = document.getElementById('landing-over50ft-safe');

            function applySafetyFactor(value) {
                return Math.round(value * (1 + parseFloat(safetyFactorSlider.value) / 100));
            }

            // --- TAKEOFF calculation ---
            function updateTakeoffPerformance() {
                const weight = parseFloat(takeoffWeightInput2.value);
                const oat = parseFloat(takeoffOATInput.value);
                const surface = takeoffSurfaceInput.value;
                const elevation = parseFloat(takeoffElevationInput.value);
                const wind = parseFloat(takeoffWindInput.value);
                
                console.log(`\nTakeoff Performance Update:`);
                console.log(`Input - Weight: ${weight}lbs, OAT: ${oat}Â°C, Surface: ${surface}, Elevation: ${elevation}ft, Wind: ${wind}kts`);
                // Calculate density altitude for performance lookup
                const densityAlt = getDensityAltitude(elevation, oat);
                // Lookup base performance using density altitude
                let perf = lookupPerformance((window.liveTakeoffData && window.liveTakeoffData.length > 0) ? window.liveTakeoffData : takeoffPerformance, densityAlt, 'takeoff');
                console.log(`Base performance:`, perf);
                
                const sfactor = surfaceFactor(surface);
                const wfactor = windFactor(wind);
                const wtfactor = weightFactor(weight);
                console.log(`Adjustment factors - Surface: ${sfactor}, Wind: ${wfactor}, Weight: ${wtfactor}`);
                
                let groundRoll = Math.round(perf.groundRoll * sfactor * wfactor * wtfactor);
                let over50ft = Math.round(perf.over50ft * sfactor * wfactor * wtfactor);
                console.log(`Final values - Ground Roll: ${groundRoll}ft, Over 50ft: ${over50ft}ft`);
                
                // Display base values
                takeoffPerfResult.textContent = `${groundRoll} ft`;
                takeoffOver50ftResult.textContent = `${over50ft} ft`;

                // Display safety margin values
                const safeGroundRoll = applySafetyFactor(groundRoll);
                const safeOver50ft = applySafetyFactor(over50ft);
                if (safetyFactorSlider.value > 0) {
                    takeoffPerfSafe.textContent = `With safety margin: ${safeGroundRoll} ft`;
                    takeoffOver50ftSafe.textContent = `With safety margin: ${safeOver50ft} ft`;
                } else {
                    takeoffPerfSafe.textContent = '';
                    takeoffOver50ftSafe.textContent = '';
                }
            }

            // --- CRUISE calculation ---
            function updateCruisePerformance() {
                const takeoffElev = parseFloat(takeoffElevationInput.value);
                const cruiseAlt = parseFloat(cruiseAltitudeInput.value);
                const takeoffOAT = parseFloat(takeoffOATInput.value);
                const takeoffWind = parseFloat(takeoffWindInput.value);
                const cruiseWind = parseFloat(windsAloftInput.value);
                let totalTimeMinutes = 0;
                let totalDistanceNm = 0;
                const altitudeIncrement = 100;

                function interpolateWind(altitude) {
                    // Linear interpolation of wind between takeoff and cruise altitude
                    const windDiff = cruiseWind - takeoffWind;
                    const altitudeDiff = cruiseAlt - takeoffElev;
                    const altitudeFraction = (altitude - takeoffElev) / altitudeDiff;
                    return takeoffWind + (windDiff * altitudeFraction);
                }

                let totalFuelBurn = 0;
                
                for (let alt = takeoffElev; alt < cruiseAlt; alt += altitudeIncrement) {
                    const currentAlt = alt;
                    const nextAlt = Math.min(alt + altitudeIncrement, cruiseAlt);
                    const segmentAltitudeChange = nextAlt - currentAlt;
                    
                    // Get ISA deviation at takeoff and calculate temperatures and density altitudes
                    const currentDA = getCruiseDensityAltitude(currentAlt, takeoffElev, takeoffOAT);
                    const nextDA = getCruiseDensityAltitude(nextAlt, takeoffElev, takeoffOAT);
                    
                    // Get performance values using density altitude
                    const rate1 = getValueFromChartData(currentDA, 'rate');
                    const rate2 = getValueFromChartData(nextDA, 'rate');
                    const avgRate = (rate1 + rate2) / 2;
                    
                    // Calculate true airspeed using density altitude
                    const ias1 = getValueFromChartData(currentDA, 'kias');
                    const ias2 = getValueFromChartData(nextDA, 'kias');
                    const tas1 = getTrueAirspeed(ias1, currentDA);
                    const tas2 = getTrueAirspeed(ias2, nextDA);
                    const avgTas = (tas1 + tas2) / 2;
                    
                    if (avgRate <= 0) break;

                    // Calculate fuel flow for this segment
                    const ff1 = getValueFromChartData(currentDA, 'fuel_flow');
                    const ff2 = getValueFromChartData(nextDA, 'fuel_flow');
                    const avgFuelFlow = (ff1 + ff2) / 2;
                    
                    // Get interpolated wind for the current segment
                    const avgAlt = (currentAlt + nextAlt) / 2;
                    const segmentWind = interpolateWind(avgAlt);
                    
                    const segmentTimeMinutes = segmentAltitudeChange / avgRate;
                    const groundSpeed = avgTas - segmentWind;
                    const segmentDistanceNm = (groundSpeed / 60) * segmentTimeMinutes;
                    
                    // Calculate fuel burn for this segment
                    const segmentTimeHours = segmentTimeMinutes / 60;
                    totalFuelBurn += avgFuelFlow * segmentTimeHours;
                    
                    totalTimeMinutes += segmentTimeMinutes;
                    totalDistanceNm += segmentDistanceNm;
                }
                const averageGradient = totalDistanceNm > 0 ? (cruiseAlt - takeoffElev) / totalDistanceNm : 0;
                const totalSeconds = Math.round(totalTimeMinutes * 60);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;

                // Calculate total fuel burn value is taken from climb segment calculations

                timeToCruiseResult.textContent = `${minutes} min ${seconds} sec`;
                distanceToCruiseResult.textContent = `${totalDistanceNm.toFixed(1)} nm`;
                avgClimbGradientResult.textContent = `${Math.round(averageGradient)} ft/nm`;
                document.getElementById('fuel-burn-result').textContent = `${totalFuelBurn.toFixed(1)} gal`;
            }

            // --- LANDING calculation ---
            function updateLandingPerformance() {
                const weight = parseFloat(landingWeightInput.value);
                const oat = parseFloat(landingOATInput.value);
                const surface = landingSurfaceInput.value;
                const elevation = parseFloat(landingElevationInput.value);
                const wind = parseFloat(landingWindInput.value);
                
                console.log(`\nLanding Performance Update:`);
                console.log(`Input - Weight: ${weight}lbs, OAT: ${oat}Â°C, Surface: ${surface}, Elevation: ${elevation}ft, Wind: ${wind}kts`);
                // Calculate density altitude for performance lookup
                const densityAlt = getDensityAltitude(elevation, oat);
                // Lookup base performance using density altitude
                let perf = lookupPerformance((window.liveLandingData && window.liveLandingData.length > 0) ? window.liveLandingData : landingPerformance, densityAlt);
                let groundRoll = Math.round(perf.groundRoll * surfaceFactor(surface) * windFactor(wind) * weightFactor(weight));
                let over50ft = Math.round(perf.over50ft * surfaceFactor(surface) * windFactor(wind) * weightFactor(weight));
                
                // Display base values
                landingPerfResult.textContent = `${groundRoll} ft`;
                landingOver50ftResult.textContent = `${over50ft} ft`;

                // Display safety margin values
                const safeGroundRoll = applySafetyFactor(groundRoll);
                const safeOver50ft = applySafetyFactor(over50ft);
                if (safetyFactorSlider.value > 0) {
                    landingPerfSafe.textContent = `With safety margin: ${safeGroundRoll} ft`;
                    landingOver50ftSafe.textContent = `With safety margin: ${safeOver50ft} ft`;
                } else {
                    landingPerfSafe.textContent = '';
                    landingOver50ftSafe.textContent = '';
                }
            }

            // --- Utility: lookup/interpolate performance ---
            function adjustForNegativeDA(baseValue, densityAlt) {
                if (densityAlt >= 0) return baseValue;
                // For negative DA, improve performance by 2% per 10 degrees below standard
                // -120ft DA represents approximately -1Â°C from standard
                // We only want to apply the improvement for actual cold temperatures
                const degreesBelowStandard = -densityAlt / 120;
                if (degreesBelowStandard <= 0) return baseValue;  // Don't adjust if not actually colder
                const performanceImprovement = 1 - (degreesBelowStandard * 0.02 / 10);
                return Math.round(baseValue * performanceImprovement);
            }

            function lookupPerformance(perfArr, densityAlt, type = 'takeoff') {
                // Apply inverse prop pitch bias to takeoff/landing distances
                // When prop is in cruise (high value), distances increase
                // When prop is in climb (low value), distances decrease
                const fullBias = 2 - window.propPitchBias; // inverse of climb bias
                // For landing, only apply half the bias effect
                const distanceBias = type === 'landing' ? 1 + (fullBias - 1) * 0.5 : fullBias;

                // Handle negative density altitude
                if (densityAlt < 0) {
                    const basePerf = {
                        groundRoll: Math.round(perfArr[0].groundRoll * distanceBias),
                        over50ft: Math.round(perfArr[0].over50ft * distanceBias)
                    };
                    return {
                        groundRoll: adjustForNegativeDA(basePerf.groundRoll, densityAlt),
                        over50ft: adjustForNegativeDA(basePerf.over50ft, densityAlt)
                    };
                }
                
                // First check for exact match to prevent interpolation errors
                const exactMatch = perfArr.find(p => p.altitude === densityAlt);
                console.log(`Looking up performance for DA: ${densityAlt}ft`);
                console.log(`Performance array:`, perfArr);
                console.log(`Exact match found:`, exactMatch);
                console.log(`Prop pitch bias:`, window.propPitchBias, `Distance bias:`, distanceBias);
                
                if (exactMatch) {
                    const result = {
                        groundRoll: Math.round(exactMatch.groundRoll * distanceBias),
                        over50ft: Math.round(exactMatch.over50ft * distanceBias)
                    };
                    console.log(`Exact match result:`, result);
                    return result;
                }
                
                for (let i = 0; i < perfArr.length-1; i++) {
                    if (densityAlt > perfArr[i].altitude && densityAlt < perfArr[i+1].altitude) {
                        const frac = (densityAlt - perfArr[i].altitude) / (perfArr[i+1].altitude - perfArr[i].altitude);
                        const baseGroundRoll = perfArr[i].groundRoll + frac * (perfArr[i+1].groundRoll - perfArr[i].groundRoll);
                        const baseOver50ft = perfArr[i].over50ft + frac * (perfArr[i+1].over50ft - perfArr[i].over50ft);
                        return {
                            groundRoll: Math.round(baseGroundRoll * distanceBias),
                            over50ft: Math.round(baseOver50ft * distanceBias)
                        };
                    }
                }
                const lastPerf = perfArr[perfArr.length-1];
                return {
                    groundRoll: Math.round(lastPerf.groundRoll * distanceBias),
                    over50ft: Math.round(lastPerf.over50ft * distanceBias)
                };
            }

            // --- Event listeners for all inputs ---
            function handleWindInput(e) {
                // No need for special handling with type="number"
                // The browser will handle negative numbers automatically
            }

            [takeoffWeightInput2, takeoffOATInput, takeoffSurfaceInput, takeoffElevationInput, takeoffWindInput].forEach(el => {
                el.addEventListener('input', (e) => {
                    if (e.target.id.includes('wind')) {
                        handleWindInput(e);
                    }
                    updateTakeoffPerformance();
                    updateTakeoffDADisplay();
                    updateCruisePerformance();
                    updateCruiseDADisplay();
                });
            });
            [cruiseAltitudeInput, windsAloftInput].forEach(el => {
                el.addEventListener('input', (e) => {
                    if (e.target.id.includes('wind')) {
                        handleWindInput(e);
                    }
                    updateCruisePerformance();
                    updateCruiseDADisplay();
                });
            });
            [landingWeightInput, landingOATInput, landingSurfaceInput, landingElevationInput, landingWindInput].forEach(el => {
                el.addEventListener('input', (e) => {
                    if (e.target.id.includes('wind')) {
                        handleWindInput(e);
                    }
                    updateLandingPerformance();
                    updateLandingDADisplay();
                });
            });

            // Update Density Altitude displays
            function updateTakeoffDADisplay() {
                const elevation = parseFloat(takeoffElevationInput.value);
                const oat = parseFloat(takeoffOATInput.value);
                const da = getDensityAltitude(elevation, oat);
                document.getElementById('takeoff-da-display').textContent = `DA: ${da.toLocaleString()} ft`;
            }

            function updateLandingDADisplay() {
                const elevation = parseFloat(landingElevationInput.value);
                const oat = parseFloat(landingOATInput.value);
                const da = getDensityAltitude(elevation, oat);
                document.getElementById('landing-da-display').textContent = `DA: ${da.toLocaleString()} ft`;
            }

            function updateCruiseDADisplay() {
                const cruiseAlt = parseFloat(cruiseAltitudeInput.value);
                const takeoffElev = parseFloat(takeoffElevationInput.value);
                const takeoffOAT = parseFloat(takeoffOATInput.value);
                const da = getCruiseDensityAltitude(cruiseAlt, takeoffElev, takeoffOAT);
                document.getElementById('cruise-da-display').textContent = `DA: ${da.toLocaleString()} ft`;
            }

            // Function to update all calculations
            function updateAllCalculations() {
                updateTakeoffPerformance();
                updateTakeoffDADisplay();
                updateCruisePerformance();
                updateCruiseDADisplay();
                updateLandingPerformance();
                updateLandingDADisplay();
            }

            // Initial calculation
            updateAllCalculations();
            // Performance Calculator elements are now part of the new tabbed interface



                        function initializePerformanceCharts() {
                                // Load user edits from localStorage if available
                                const savedClimb = localStorage.getItem('climbPerformanceData');
                                const savedTakeoff = localStorage.getItem('takeoffPerformanceData');
                                const savedLanding = localStorage.getItem('landingPerformanceData');
                                const savedCruise = localStorage.getItem('cruisePerformanceData');
                                
                                // Deep copy of initial data with all properties
                                window.liveChartData = savedClimb ? JSON.parse(savedClimb) : initialPerformanceData.map(row => ({
                                    altitude: row.altitude,
                                    kias: row.kias,
                                    rate: row.rate,
                                    fuel_flow: row.fuel_flow
                                }));
                                window.liveTakeoffData = savedTakeoff ? JSON.parse(savedTakeoff) : takeoffPerformance.slice();
                                window.liveLandingData = savedLanding ? JSON.parse(savedLanding) : landingPerformance.slice();
                                window.liveCruiseData = savedCruise ? JSON.parse(savedCruise) : initialCruiseData.map(row => ({
                                    altitude: row.altitude,
                                    econ_ktas: row.econ_ktas,
                                    econ_ff: row.econ_ff,
                                    fast_ktas: row.fast_ktas,
                                    fast_ff: row.fast_ff
                                }));
                                console.log('Initializing charts:', {
                                    climb: window.liveChartData,
                                    takeoff: window.liveTakeoffData,
                                    landing: window.liveLandingData,
                                    cruise: window.liveCruiseData
                                });
                                renderChart();
                        }

            // ...existing code...
            // Ensure charts are initialized after all definitions
            initializePerformanceCharts();

            // All element declarations are now inside DOMContentLoaded

            // --- Tab Switching Logic ---
            function switchTab(tab) {
                if (tab === 'chart') {
                    tab1Btn.classList.add('border-blue-600');
                    tab2Btn.classList.remove('border-blue-600');
                    tab1Content.classList.add('active');
                    tab2Content.classList.remove('active');
                } else {
                    tab2Btn.classList.add('border-blue-600');
                    tab1Btn.classList.remove('border-blue-600');
                    tab2Content.classList.add('active');
                    tab1Content.classList.remove('active');
                }
            }

            tab1Btn.addEventListener('click', () => switchTab('chart'));
            tab2Btn.addEventListener('click', () => switchTab('calculator'));

            // Set initial active tab
            tab1Btn.classList.add('border-blue-600');
            tab1Content.classList.add('active');


            /**
             * Displays a message in the message box.
             * @param {string} message - The message to display.
             * @param {string} type - 'success' or 'error'.
             */
            function showMessage(message, type) {
                messageText.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-300', 'text-red-700', 'bg-green-100', 'border-green-300', 'text-green-700');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'border-red-300', 'text-red-700');
                } else {
                    messageBox.classList.add('bg-green-100', 'border-green-300', 'text-green-700');
                }
                messageBox.classList.remove('hidden');
            }

            /**
             * Looks up or interpolates climb data for a given altitude from liveChartData.
             * @param {number} altitude - The altitude in feet.
             * @param {string} dataType - 'kias' or 'rate'.
             * @returns {number} The estimated value.
             */
            function getValueFromChartData(altitude, dataType) {
                if (!window.liveChartData || window.liveChartData.length === 0) return 0;
                
                // First check if the dataType exists in the data
                if (window.liveChartData[0][dataType] === undefined) {
                    console.warn(`Data type ${dataType} not found in performance data`);
                    return 0;
                }
                
                if (altitude < 0) {
                    // For negative density altitude, use sea level value and apply improvement
                    const baseValue = window.liveChartData[0][dataType];
                    const adjustedValue = adjustForNegativeDA(baseValue, altitude);
                    // Only apply prop pitch bias to rate, not to kias or fuel_flow
                    return dataType === 'rate' ? adjustedValue * window.propPitchBias : adjustedValue;
                }
                if (altitude < window.liveChartData[0].altitude) {
                    const value = window.liveChartData[0][dataType];
                    return dataType === 'rate' ? value * window.propPitchBias : value;
                }
                if (altitude > window.liveChartData[window.liveChartData.length - 1].altitude) {
                    const value = window.liveChartData[window.liveChartData.length - 1][dataType];
                    return dataType === 'rate' ? value * window.propPitchBias : value;
                }

                for (let i = 0; i < window.liveChartData.length - 1; i++) {
                    const p1 = window.liveChartData[i];
                    const p2 = window.liveChartData[i + 1];
                    if (altitude >= p1.altitude && altitude <= p2.altitude) {
                        const altitudeFraction = (altitude - p1.altitude) / (p2.altitude - p1.altitude);
                        const interpolatedValue = p1[dataType] + altitudeFraction * (p2[dataType] - p1[dataType]);
                        return dataType === 'rate' ? interpolatedValue * window.propPitchBias : interpolatedValue;
                    }
                }
                return window.liveChartData[window.liveChartData.length - 1][dataType];
            }


            /**
             * Calculates the True Airspeed (KTAS) from Indicated Airspeed (KIAS) and altitude.
             * @param {number} ias - The Indicated Airspeed in knots.
             * @param {number} altitude - The altitude in feet.
             * @returns {number} The estimated KTAS.
             */
            function getTrueAirspeed(ias, densityAltitude) {
                // TAS increases by approximately 2% per 1000 feet of density altitude
                const tas = ias * (1 + (densityAltitude / 1000) * 0.02);
                return Math.round(tas);
            }

            /**
             * Generates the performance chart table rows and new distance charts.
             */
                        function renderChart() {
                                if (!window.chartBody || !window.takeoffDistanceBody || !window.landingDistanceBody) {
                                    console.error('Chart containers not found:', { chartBody: window.chartBody, takeoffDistanceBody: window.takeoffDistanceBody, landingDistanceBody: window.landingDistanceBody });
                                    return;
                                }
                window.chartBody.innerHTML = '';
                window.takeoffDistanceBody.innerHTML = '';
                window.landingDistanceBody.innerHTML = '';                // Main climb chart (editable)
                window.liveChartData.forEach((dataPoint, index) => {
                    const tas = getTrueAirspeed(dataPoint.kias, dataPoint.altitude);
                    const speedNmPerMin = tas / 60;
                    const climbGradient = speedNmPerMin > 0 ? dataPoint.rate / speedNmPerMin : 0;
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-2 font-semibold">${dataPoint.altitude.toLocaleString()}</td>
                        <td class="py-3 px-2 text-center">${dataPoint.kias}</td>
                        <td class="py-3 px-2 text-center">${dataPoint.rate}</td>
                        <td class="py-3 px-2 text-center">${dataPoint.fuel_flow ? dataPoint.fuel_flow.toFixed(1) : '0.0'}</td>
                        <td class="py-3 px-2 text-center">${Math.round(tas)}</td>
                        <td class="py-3 px-2 text-center">${Math.round(climbGradient)}</td>
                    `;
                    window.chartBody.appendChild(row);
                    // ...existing code for event listeners...
                    const rateInput = row.querySelector('input[data-type="rate"]');
                    if (rateInput) {
                        rateInput.addEventListener('input', (e) => {
                            const newRate = parseFloat(e.target.value);
                            const dataIndex = parseInt(e.target.dataset.index, 10);
                            if (!isNaN(newRate)) {
                                window.liveChartData[dataIndex].rate = newRate;
                                renderChart();
                            }
                        });
                    }
                    const iasInput = row.querySelector('input[data-type="kias"]');
                    if (iasInput) {
                        iasInput.addEventListener('input', (e) => {
                            const newIas = parseFloat(e.target.value);
                            const dataIndex = parseInt(e.target.dataset.index, 10);
                            if (!isNaN(newIas)) {
                                window.liveChartData[dataIndex].kias = newIas;
                                renderChart();
                            }
                        });
                    }
                });

                // Takeoff Distance Chart (editable)
                window.liveTakeoffData.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-200 hover:bg-blue-50';
                    tr.innerHTML = `
                        <td class="py-3 px-2 font-semibold">${row.altitude}</td>
                        <td class="py-3 px-2 text-center">${row.groundRoll}</td>
                        <td class="py-3 px-2 text-center">${row.over50ft}</td>
                    `;
                    window.takeoffDistanceBody.appendChild(tr);
                });

                // Landing Distance Chart (editable)
                window.liveLandingData.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-200 hover:bg-green-50';
                    tr.innerHTML = `
                        <td class="py-3 px-2 font-semibold">${row.altitude}</td>
                        <td class="py-3 px-2 text-center">${row.groundRoll}</td>
                        <td class="py-3 px-2 text-center">${row.over50ft}</td>
                    `;
                    window.landingDistanceBody.appendChild(tr);
                });
                // Cruise Performance Chart
                const cruiseBody = document.getElementById('cruise-body');
                if (cruiseBody) {
                    cruiseBody.innerHTML = '';
                    window.liveCruiseData.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-gray-200 hover:bg-purple-50';
                        tr.innerHTML = `
                            <td class="py-3 px-2 font-semibold">${row.altitude.toLocaleString()}</td>
                            <td class="py-3 px-2 text-center">${Math.round(row.econ_ktas)}</td>
                            <td class="py-3 px-2 text-center">${row.econ_ff.toFixed(1)}</td>
                            <td class="py-3 px-2 text-center">${Math.round(row.fast_ktas)}</td>
                            <td class="py-3 px-2 text-center">${row.fast_ff.toFixed(1)}</td>
                        `;
                        cruiseBody.appendChild(tr);
                    });
                }
                
                // Do not render cruise table in calculator tab
                console.log('Charts rendered.');
            }
            
            // Calculation logic is now handled by updateTakeoffPerformance, updateCruisePerformance, and updateLandingPerformance functions

            // Add event listeners for save and reset buttons
            saveDataBtn.addEventListener('click', function() {
                localStorage.setItem('climbPerformanceData', JSON.stringify(window.liveChartData));
                localStorage.setItem('takeoffPerformanceData', JSON.stringify(window.liveTakeoffData));
                localStorage.setItem('landingPerformanceData', JSON.stringify(window.liveLandingData));
                showMessage('Performance data saved successfully!', 'success');
            });

            resetDataBtn.addEventListener('click', async function() {
                localStorage.removeItem('climbPerformanceData');
                localStorage.removeItem('takeoffPerformanceData');
                localStorage.removeItem('landingPerformanceData');
                await initializePerformanceCharts();
                showMessage('Performance data reset to default values.', 'success');
            });
            // Removed all weight adjustment logic and buttons for Performance Chart tab

            // Add event listener for prop pitch bias slider
            const propPitchSlider = document.getElementById('prop-pitch-bias');
            const propPitchValue = document.getElementById('prop-pitch-value');
            
            if (propPitchSlider) {
                // Load saved bias if exists
                const savedBias = localStorage.getItem('propPitchBias');
                if (savedBias !== null) {
                    const biasValue = parseInt(savedBias);
                    propPitchSlider.value = biasValue;
                    window.propPitchBias = biasValue / 100;
                    propPitchValue.textContent = biasValue + '%';
                }

                propPitchSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    propPitchValue.textContent = value + '%';

                    // Calculate bias factors
                    const climbBias = (200 - value) / 100; // 120% becomes 0.8 (worse climb), 80% becomes 1.2 (better climb)
                    const takeoffBias = 2 - climbBias; // inverse effect for distances
                    const landingBias = 1 + (takeoffBias - 1) * 0.5; // half effect for landing
                    
                    // Calculate cruise performance changes
                    const propChange = (value - 100) / 3; // Convert slider value to percentage points (each 3% increase in pitch)

                    // Update climb performance data
                    window.liveChartData = initialPerformanceData.map(row => ({
                        altitude: row.altitude,
                        kias: row.kias,
                        rate: Math.round(row.rate * climbBias),
                        fuel_flow: row.fuel_flow  // Preserve fuel flow values
                    }));

                    // Update takeoff distance data
                    window.liveTakeoffData = takeoffPerformance.map(row => ({
                        ...row,
                        groundRoll: Math.round(row.groundRoll * takeoffBias),
                        over50ft: Math.round(row.over50ft * takeoffBias)
                    }));

                    // Update landing distance data
                    window.liveLandingData = landingPerformance.map(row => ({
                        ...row,
                        groundRoll: Math.round(row.groundRoll * landingBias),
                        over50ft: Math.round(row.over50ft * landingBias)
                    }));

                    // Update cruise performance data
                    window.liveCruiseData = initialCruiseData.map(row => ({
                        altitude: row.altitude,
                        econ_ktas: row.econ_ktas * (1 + propChange * 0.01),  // 1% increase per 3% pitch
                        econ_ff: Math.max(0, row.econ_ff - propChange * 0.1),  // 0.1 gph reduction per 3% pitch
                        fast_ktas: row.fast_ktas * (1 + propChange * 0.004),  // 0.40% increase per 3% pitch
                        fast_ff: Math.max(0, row.fast_ff - propChange * 0.15)  // 0.15 gph reduction per 3% pitch
                    }));

                    renderChart();
                    // Update all performance calculations
                    updateTakeoffPerformance();
                    updateCruisePerformance();
                    updateLandingPerformance();
                });
            }

            if (saveDataBtn) {
                saveDataBtn.addEventListener('click', function() {
                    localStorage.setItem('propPitchBias', propPitchSlider.value);
                    localStorage.setItem('climbPerformanceData', JSON.stringify(window.liveChartData));
                    localStorage.setItem('takeoffPerformanceData', JSON.stringify(window.liveTakeoffData));
                    localStorage.setItem('landingPerformanceData', JSON.stringify(window.liveLandingData));
                    showMessage('Performance data saved successfully!', 'success');
                });
            }

            if (resetDataBtn) {
                resetDataBtn.addEventListener('click', async function() {
                    localStorage.removeItem('propPitchBias');
                    localStorage.removeItem('climbPerformanceData');
                    localStorage.removeItem('takeoffPerformanceData');
                    localStorage.removeItem('landingPerformanceData');
                    propPitchSlider.value = 100;
                    window.propPitchBias = 1.0;
                    propPitchValue.textContent = '100%';
                    await initializePerformanceCharts();
                    showMessage('Performance data reset to default values.', 'success');
                });
            }

            // Safety Factor slider handler
            if (safetyFactorSlider) {
                safetyFactorSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    safetyFactorValue.textContent = value + '%';
                    
                    // Update both takeoff and landing calculations to show new safety margins
                    updateTakeoffPerformance();
                    updateLandingPerformance();
                });
            }

            // Calculator Save/Reset functionality
            const calculatorFields = {
                'takeoff-weight-input': 1700,
                'takeoff-oat': 15,
                'takeoff-surface': 'paved',
                'takeoff-elevation': 0,
                'takeoff-wind': 0,
                'cruise-altitude': 5000,
                'winds-aloft': 0,
                'landing-weight': 1700,
                'landing-oat': 15,
                'landing-surface': 'paved',
                'landing-elevation': 0,
                'landing-wind': 0,
                'safety-factor': 25
            };

            function saveCalculatorSettings() {
                const settings = {};
                Object.keys(calculatorFields).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        settings[fieldId] = element.value;
                    }
                });
                localStorage.setItem('calculatorSettings', JSON.stringify(settings));
                showMessage('Calculator settings saved successfully!', 'success');
            }

            function resetCalculatorSettings() {
                Object.entries(calculatorFields).forEach(([fieldId, defaultValue]) => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = defaultValue;
                    }
                });
                localStorage.removeItem('calculatorSettings');
                // Update all calculations after resetting values
                updateAllCalculations();
                showMessage('Calculator settings reset to default values.', 'success');
            }

            function loadCalculatorSettings() {
                const savedSettings = localStorage.getItem('calculatorSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    Object.keys(settings).forEach(fieldId => {
                        const element = document.getElementById(fieldId);
                        if (element) {
                            element.value = settings[fieldId];
                        }
                    });
                }
                // Update all calculations after loading values
                updateAllCalculations();
            }

            // Add event listeners for calculator save/reset buttons
            const saveCalculatorBtn = document.getElementById('save-calculator-btn');
            const resetCalculatorBtn = document.getElementById('reset-calculator-btn');

            if (saveCalculatorBtn) {
                saveCalculatorBtn.addEventListener('click', saveCalculatorSettings);
            }

            if (resetCalculatorBtn) {
                resetCalculatorBtn.addEventListener('click', resetCalculatorSettings);
            }

            // Load saved calculator settings on page load
            loadCalculatorSettings();

            // Initial rendering of the chart with default values
            initializePerformanceCharts();

            // Tooltip handling
            function createTooltip(text) {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = text;
                return tooltip;
            }

            function createInfoButton() {
                const button = document.createElement('button');
                button.className = 'info-button';
                button.innerHTML = 'i';
                button.setAttribute('type', 'button');
                return button;
            }

            function setupTooltips() {
                document.querySelectorAll('[title]').forEach(element => {
                    const tooltipText = element.getAttribute('title');
                    element.removeAttribute('title');
                    
                    const wrapper = document.createElement('div');
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'center';
                    
                    // If the element is an input, wrap it
                    if (element.tagName === 'INPUT' || element.tagName === 'SELECT') {
                        element.parentNode.insertBefore(wrapper, element);
                        wrapper.appendChild(element);
                    } else {
                        element.parentNode.replaceChild(wrapper, element);
                        wrapper.appendChild(element);
                    }
                    
                    const infoButton = createInfoButton();
                    const tooltip = createTooltip(tooltipText);
                    wrapper.appendChild(infoButton);
                    wrapper.appendChild(tooltip);

                    let activeTooltip = null;
                    
                    infoButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (activeTooltip) {
                            activeTooltip.classList.remove('visible');
                        }
                        if (activeTooltip !== tooltip) {
                            tooltip.classList.add('visible');
                            
                            // Position the tooltip
                            const rect = infoButton.getBoundingClientRect();
                            const spaceBelow = window.innerHeight - rect.bottom;
                            const spaceRight = window.innerWidth - rect.right;
                            
                            if (spaceBelow < 200 && rect.top > 200) {
                                // Show above if not enough space below
                                tooltip.style.bottom = (window.innerHeight - rect.top + 10) + 'px';
                                tooltip.style.top = 'auto';
                            } else {
                                // Show below
                                tooltip.style.top = (rect.bottom + 10) + 'px';
                                tooltip.style.bottom = 'auto';
                            }
                            
                            if (spaceRight < 200) {
                                // Align right edge with button if near right edge
                                tooltip.style.right = (window.innerWidth - rect.right) + 'px';
                                tooltip.style.left = 'auto';
                            } else {
                                // Align left edge with button
                                tooltip.style.left = rect.left + 'px';
                                tooltip.style.right = 'auto';
                            }
                            
                            activeTooltip = tooltip;
                        } else {
                            activeTooltip = null;
                        }
                    });
                });

                // Close tooltip when clicking outside
                document.addEventListener('click', () => {
                    const visibleTooltips = document.querySelectorAll('.tooltip.visible');
                    visibleTooltips.forEach(t => t.classList.remove('visible'));
                    activeTooltip = null;
                });
            }

            // Initialize tooltips
            setupTooltips();
        });
</script>
</body>
</html>